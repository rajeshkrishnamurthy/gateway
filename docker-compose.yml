x-go-service: &go-service
  build:
    context: .
    dockerfile: Dockerfile.dev
  working_dir: /app/backend
  volumes:
    - ./backend:/app/backend
    - ./ui:/app/ui
    - go-mod-cache:/go/pkg/mod
    - go-build-cache:/root/.cache/go-build

services:
  grafana:
    image: grafana/grafana:latest
    environment:
      GF_SECURITY_ALLOW_EMBEDDING: "true"
      GF_LOG_LEVEL: "error"
    ports:
      - "3000:3000"
    volumes:
      - ./backend/conf/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./backend/conf/grafana/dashboards:/var/lib/grafana/dashboards:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:3000/api/health"]
      interval: 5s
      timeout: 2s
      retries: 5
      start_period: 10s

  prometheus:
    image: prom/prometheus:latest
    command: ["--config.file=/etc/prometheus/prometheus.yml", "--log.level=error"]
    ports:
      - "9090:9090"
    volumes:
      - ./backend/conf/prometheus_docker.yml:/etc/prometheus/prometheus.yml:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:9090/-/ready"]
      interval: 5s
      timeout: 2s
      retries: 5
      start_period: 10s

  model-provider:
    <<: *go-service
    command: ["go", "run", "./cmd/fake-provider/modelprovider", "-addr", ":9091"]
    ports:
      - "9091:9091"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:9091/readyz"]
      interval: 5s
      timeout: 2s
      retries: 5
      start_period: 5s

  sms-gateway-1:
    <<: *go-service
    command: ["go", "run", "./cmd/sms-gateway", "-config", "conf/config_docker.json", "-addr", ":8080"]
    depends_on:
      - model-provider
    ports:
      - "18080:8080"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8080/readyz"]
      interval: 5s
      timeout: 2s
      retries: 5
      start_period: 5s
  sms-gateway-2:
    <<: *go-service
    command: ["go", "run", "./cmd/sms-gateway", "-config", "conf/config_docker.json", "-addr", ":8080"]
    depends_on:
      - model-provider
    ports:
      - "18081:8080"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8080/readyz"]
      interval: 5s
      timeout: 2s
      retries: 5
      start_period: 5s

  push-gateway-1:
    <<: *go-service
    environment:
      PUSH_FCM_BEARER_TOKEN: "dev"
    command: ["go", "run", "./cmd/push-gateway", "-config", "conf/config_push_docker.json", "-addr", ":8081"]
    ports:
      - "19080:8081"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8081/readyz"]
      interval: 5s
      timeout: 2s
      retries: 5
      start_period: 5s
  push-gateway-2:
    <<: *go-service
    environment:
      PUSH_FCM_BEARER_TOKEN: "dev"
    command: ["go", "run", "./cmd/push-gateway", "-config", "conf/config_push_docker.json", "-addr", ":8081"]
    ports:
      - "19081:8081"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8081/readyz"]
      interval: 5s
      timeout: 2s
      retries: 5
      start_period: 5s

  haproxy:
    image: setu-haproxy
    build:
      context: .
      dockerfile: Dockerfile.curl
      args:
        BASE_IMAGE: haproxy:2.8
        RUNTIME_USER: haproxy
    ports:
      - "8080:8080"
      - "8081:8081"
      - "8404:8404"
    volumes:
      - ./backend/conf/haproxy_docker.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    depends_on:
      - sms-gateway-1
      - sms-gateway-2
      - push-gateway-1
      - push-gateway-2
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8404/stats"]
      interval: 5s
      timeout: 2s
      retries: 5
      start_period: 5s

  admin-portal:
    <<: *go-service
    command: ["go", "run", "./cmd/admin-portal", "-config", "conf/admin_portal_docker.json", "-addr", ":8090"]
    ports:
      - "8090:8090"
    depends_on:
      - haproxy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8090/readyz"]
      interval: 5s
      timeout: 2s
      retries: 5
      start_period: 5s

volumes:
  go-mod-cache:
  go-build-cache:
